<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[译] 使用 Angular 和 RxJS 实现的无限滚动加载 | Rxjs</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="目录">
    <link rel="preload" href="/assets/css/0.styles.ccac5a78.css" as="style"><link rel="preload" href="/assets/js/app.de24a261.js" as="script"><link rel="preload" href="/assets/js/2.f6e3d3ee.js" as="script"><link rel="preload" href="/assets/js/8.b99143ac.js" as="script"><link rel="prefetch" href="/assets/js/10.157238cf.js"><link rel="prefetch" href="/assets/js/11.41a012c6.js"><link rel="prefetch" href="/assets/js/12.b8086885.js"><link rel="prefetch" href="/assets/js/13.e45c7342.js"><link rel="prefetch" href="/assets/js/14.e3e54685.js"><link rel="prefetch" href="/assets/js/15.9351c89b.js"><link rel="prefetch" href="/assets/js/16.7d3aff72.js"><link rel="prefetch" href="/assets/js/17.cd3a7c14.js"><link rel="prefetch" href="/assets/js/18.7b5bc8d2.js"><link rel="prefetch" href="/assets/js/19.77700336.js"><link rel="prefetch" href="/assets/js/20.ca0fdbb6.js"><link rel="prefetch" href="/assets/js/21.d6bc78c5.js"><link rel="prefetch" href="/assets/js/22.2428074e.js"><link rel="prefetch" href="/assets/js/23.93a777ed.js"><link rel="prefetch" href="/assets/js/24.73aa7224.js"><link rel="prefetch" href="/assets/js/25.e43f6412.js"><link rel="prefetch" href="/assets/js/26.60ae3da3.js"><link rel="prefetch" href="/assets/js/27.03e00c07.js"><link rel="prefetch" href="/assets/js/28.95c8c079.js"><link rel="prefetch" href="/assets/js/29.eb8ac4a8.js"><link rel="prefetch" href="/assets/js/3.d907f710.js"><link rel="prefetch" href="/assets/js/30.5c09e00d.js"><link rel="prefetch" href="/assets/js/31.962a908d.js"><link rel="prefetch" href="/assets/js/32.c0fe7bdd.js"><link rel="prefetch" href="/assets/js/33.74f04d2b.js"><link rel="prefetch" href="/assets/js/34.20bdc3d5.js"><link rel="prefetch" href="/assets/js/35.d30ab2c2.js"><link rel="prefetch" href="/assets/js/36.d13995e1.js"><link rel="prefetch" href="/assets/js/37.08e1d965.js"><link rel="prefetch" href="/assets/js/38.fae351d3.js"><link rel="prefetch" href="/assets/js/39.a40c9688.js"><link rel="prefetch" href="/assets/js/4.fe9ea34b.js"><link rel="prefetch" href="/assets/js/40.87c8b8ee.js"><link rel="prefetch" href="/assets/js/41.242cc580.js"><link rel="prefetch" href="/assets/js/42.736834a5.js"><link rel="prefetch" href="/assets/js/43.57a7a89e.js"><link rel="prefetch" href="/assets/js/44.2c085c54.js"><link rel="prefetch" href="/assets/js/45.fcfe6221.js"><link rel="prefetch" href="/assets/js/46.31dda88a.js"><link rel="prefetch" href="/assets/js/5.7bdab572.js"><link rel="prefetch" href="/assets/js/6.af184b79.js"><link rel="prefetch" href="/assets/js/7.d5eaab60.js"><link rel="prefetch" href="/assets/js/9.55a51475.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ccac5a78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Rxjs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/rxjs-docs/home.html" class="nav-link">
  rxjs
</a></div><div class="nav-item"><a href="/articles/home.html" class="nav-link">
  精选文章
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/rxjs-docs/home.html" class="nav-link">
  rxjs
</a></div><div class="nav-item"><a href="/articles/home.html" class="nav-link">
  精选文章
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/articles/home.html" class="sidebar-link">RxJS 优质文章翻译</a></li><li><a href="/articles/articles/ADVANCED-CACHING-WITH-RXJS.html" class="sidebar-link">[译] RxJS 高级缓存</a></li><li><a href="/articles/articles/Angular-Simple-Infinite-Scroller-Directive-With-RxJS-Observables.html" class="sidebar-link">[译] Angular: 使用 RxJS Observables 来实现简易版的无限滚动加载指令</a></li><li><a href="/articles/articles/Debugging-RxJS-Part1-Tooling.html" class="sidebar-link">[译] 调试 RxJS 第1部分: 工具篇</a></li><li><a href="/articles/articles/Debugging-RxJS-Part2-Logging.html" class="sidebar-link">[译] 调试 RxJS 第2部分: 日志篇</a></li><li><a href="/articles/articles/Don't-Unsubscribe.html" class="sidebar-link">[译] RxJS: 别取消订阅</a></li><li><a href="/articles/articles/Hot-Vs-Cold-Observables.html" class="sidebar-link">[译] 热的 Vs 冷的 Observables</a></li><li><a href="/articles/articles/How-To-Use-RefCount.html" class="sidebar-link">[译] RxJS: 如何使用 refCount</a></li><li><a href="/articles/articles/Infinite-Scroll-In-Angular-An-RxJS.html" aria-current="page" class="active sidebar-link">[译] 使用 Angular 和 RxJS 实现的无限滚动加载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/articles/Infinite-Scroll-In-Angular-An-RxJS.html#关于本文" class="sidebar-link">关于本文</a></li><li class="sidebar-sub-header"><a href="/articles/articles/Infinite-Scroll-In-Angular-An-RxJS.html#响应式编程" class="sidebar-link">响应式编程</a></li><li class="sidebar-sub-header"><a href="/articles/articles/Infinite-Scroll-In-Angular-An-RxJS.html#无限滚动加载应该是怎样的" class="sidebar-link">无限滚动加载应该是怎样的？</a></li><li class="sidebar-sub-header"><a href="/articles/articles/Infinite-Scroll-In-Angular-An-RxJS.html#首先画图" class="sidebar-link">首先画图</a></li><li class="sidebar-sub-header"><a href="/articles/articles/Infinite-Scroll-In-Angular-An-RxJS.html#开始编码" class="sidebar-link">开始编码</a></li></ul></li><li><a href="/articles/articles/Learn-To-Combine-RxJS-Sequences-With-Super-Intuitive-Interactive-Diagrams.html" class="sidebar-link">[译] RxJS: 使用超直观的交互图来学习组合操作符</a></li><li><a href="/articles/articles/Learning-Observable-By-Building-Observable.html" class="sidebar-link">[译] 通过构建 Observable 来学习 Observable</a></li><li><a href="/articles/articles/Naive-Infinite-Scroll-In-Reactive-Programming-Using-RxJS-Observables.html" class="sidebar-link">[译] 使用响应式编程来实现简易版的无限滚动加载</a></li><li><a href="/articles/articles/On-The-Subject-Of-Subjects.html" class="sidebar-link">[译] 关于 RxJS 中的 Subject</a></li><li><a href="/articles/articles/PRIMER-ON-RXJS-SCHEDULERS.html" class="sidebar-link">[译] RxJS 调度器入门</a></li><li><a href="/articles/articles/Reactive-Brain-Waves.html" class="sidebar-link">[译] 响应式脑电波</a></li><li><a href="/articles/articles/RxJS-Observable-Interop-With-Promises-And-Async-Await.html" class="sidebar-link">[译] RxJS Observable 与 Promises 和 Async-Await 交互</a></li><li><a href="/articles/articles/Six-Operators-That-You-Must-Know.html" class="sidebar-link">[译] RxJS: 6个你必须知道的操作符</a></li><li><a href="/articles/articles/Subjects-For-Human-Beings.html" class="sidebar-link">[译] RxJS: 白话 Subjects</a></li><li><a href="/articles/articles/TAMING-SNAKES-WITH-REACTIVE-STREAMS.html" class="sidebar-link">[译] RxJS 游戏之贪吃蛇</a></li><li><a href="/articles/articles/Testing-Race-Conditions-Using-RxJS-Marbles.html" class="sidebar-link">[译] RxJS 进阶技巧: 使用 RxJS Marbles 测试竞争条件</a></li><li><a href="/articles/articles/Understanding-Subjects-in-RxJS.html" class="sidebar-link">[译] 理解 RxJS 中 Subjects</a></li><li><a href="/articles/articles/Understanding-The-Publish-And-Share-Operators.html" class="sidebar-link">[译] RxJS: 理解 publish 和 share 操作符</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="译-使用-angular-和-rxjs-实现的无限滚动加载"><a href="#译-使用-angular-和-rxjs-实现的无限滚动加载" class="header-anchor">#</a> [译] 使用 Angular 和 RxJS 实现的无限滚动加载</h1> <blockquote><p>原文链接: <a href="https://blog.strongbrew.io/infinite-scroll-with-rxjs-and-angular2/" target="_blank" rel="noopener noreferrer">https://blog.strongbrew.io/infinite-scroll-with-rxjs-and-angular2/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h2 id="关于本文"><a href="#关于本文" class="header-anchor">#</a> 关于本文</h2> <p>本文讲解了如何使用“响应式编程”的方式以少量的代码实现出超棒的<strong>无限滚动加载列表</strong>。对于本文，我们将使用 <a href="http://reactivex.io/rxjs/" target="_blank" rel="noopener noreferrer">RxJS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 <a href="https://angular.io/" target="_blank" rel="noopener noreferrer">Angular<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。如果 <a href="http://reactivex.io/rxjs/" target="_blank" rel="noopener noreferrer">RxJS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对你来说是全新概念的话，那么最好先阅读下官方文档。但无论是使用 <a href="https://angular.io/" target="_blank" rel="noopener noreferrer">Angular<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 还是 <a href="https://facebook.github.io/react/" target="_blank" rel="noopener noreferrer">React<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，都不会影响到本文的流畅度。</p> <h2 id="响应式编程"><a href="#响应式编程" class="header-anchor">#</a> 响应式编程</h2> <p>相比于命令式编程，响应式编程有如下优势:</p> <ul><li>不再有“if xx, else xx” 这种场景</li> <li>可以忘记大量的边缘案例</li> <li>很容易将展现层逻辑跟其他逻辑分离 (展现层只对流作出响应)</li> <li>本身就是标准: 被广泛的语言所支持</li> <li>当理解这些概念后，可以以一种非常简单的方式将复杂的逻辑用很少的代码来实现</li></ul> <p>几天前，我的一个同事来找我探讨问题: 他想要<strong>在 Angular 中实现无限滚动加载</strong>功能，但是他无意间触碰到了命令式编程的边界。而事实也证明了，无限滚动加载解决方案实际上是一个很好的例子，可以解释响应式编程如何帮助你来更好地编写代码。</p> <h2 id="无限滚动加载应该是怎样的"><a href="#无限滚动加载应该是怎样的" class="header-anchor">#</a> 无限滚动加载应该是怎样的？</h2> <p>无限滚动加载列表在用户将页面滚动到指定位置后会异步加载数据。这是避免寻主动加载(每次都需要用户去点击)的好方法，而且它能真正保持应用的性能。同时它还是降低带宽和增强用户体验的有效方法。</p> <p>对于这种场景，假设说每个页面包含10条数据，并且所有数据都在一个可滚动的长列表中显示，这就是无限滚动加载列表。</p> <p>我们来把无限滚动加载列表必须要满足的功能列出来:</p> <ul><li>默认应该加载第一页的数据</li> <li>当首页的数据不能完全填充首屏的话，应该加载第二页的数据，以此类推，直到首屏填充满</li> <li>当用户向下滚动，应该加载第三页的数据，并依次类推</li> <li>当用户调整窗口大小后，有更多空间来展示结果，此时应该加载下一页数据</li> <li>应该确保同一页数据不会被加载两次 (缓存)</li></ul> <h2 id="首先画图"><a href="#首先画图" class="header-anchor">#</a> 首先画图</h2> <p>就像大多数编码决策一样，先在白板上画出来是个好主意。这可能是一种个人方式，但它有助于我编写出的代码不至于在稍后阶段被删除或重构。</p> <p>根据上面的功能列表来看，有三个动作可以使应用触发加载数据: 滚动、调整窗口大小和手动触发数据加载。当我们用响应式思维来思考时，可以发现有3中事件的来源，我们将其称之为流:</p> <ul><li>scroll 事件的流: <strong>scroll$</strong></li> <li>resize 事件的流: <strong>resize$</strong></li> <li>手动决定加载第几页数据的流: <strong>pageByManual$</strong></li></ul> <p><strong>注意: 我们会给流变量加后缀$以表明这是流，这是一种约定(个人也更喜欢这种方式)</strong></p> <p>我们在白板上画出这些流:</p> <p><img src="/assets/img/marble-diagram-1.818ed2d0.png" alt="marble-diagram-1"></p> <p>随着时间的推移，这些流上会包含具体的值:</p> <p><img src="/assets/img/marble-diagram-2.e836b93d.png" alt="marble-diagram-2"></p> <p><code>scroll$</code> 流包含 Y 值，它用来计算页码。</p> <p><code>resize$</code> 流包含 event 值。我们并不需要值本身，但我们需要知道用户调整了窗口大小。</p> <p><code>pageByManual$</code> 包含页码，因为它是一个 Subject，所以我们可以直接设置它。(稍后再讲)</p> <p>如果我们可以将所有这些流映射成页码的流呢？那就太好了，因为基于页码才能加载指定页的数据。那么如何把当前的流映射成页码的流呢？这不是我们现在需要考虑的事情(我们只是在绘图，还记得吗?)。下一个图看起来是这样的:</p> <p><img src="/assets/img/marble-diagram-3.6a892767.png" alt="marble-diagram-3"></p> <p>从图中可以看到，我们基于初始的流创建出了下面的流:</p> <ul><li><strong>pageByScroll$</strong>: 包含基于 scroll 事件的页码</li> <li><strong>pageByResize$</strong>: 包含基于 resize 事件的页码</li> <li><strong>pageByManual$</strong>: 包含基于手动事件的页码 (例如，如果页面上仍有空白区域，我们需要加载下一页数据)</li></ul> <p>如果我们能够以有效的方式合并这3个页码流，那么我们将得到一个名为 <strong><code>pageToLoad$</code></strong> 的新的流，它包含由 scroll 事件、resize 事件和手动事件所创建的页码。</p> <p><img src="/assets/img/marble-diagram-4.ffdf1b21.png" alt="marble-diagram-4"></p> <p>如果我们订阅 <code>pageToLoad$</code> 流而不从服务中获取数据的话，那么我们的无限滚动加载已经可以部分工作了。但是，我们不是要以响应式的思维来思考吗？这就意味着要尽可能地避免订阅... 实际上，我们需要基于 <code>pageToLoad$</code> 流来创建一个新的流，它将包含无限滚动加载列表中的数据...</p> <p><img src="/assets/img/marble-diagram-5.630b4a67.png" alt="marble-diagram-5"></p> <p>现在将这些图合并成一个全面的设计图。</p> <p><img src="/assets/img/marble-diagram-6.75796002.png" alt="marble-diagram-6"></p> <p>如果所示，我们有3个输入流: 它们分别负责处理滚动、调整窗口大小和手动触发。然后，我们有3个基于输入流的页码流，并将其合并成一个流，即 <code>pageToLoad$</code> 流。基于 <code>pageToLoad$</code> 流，我们便可以获取数据。</p> <h2 id="开始编码"><a href="#开始编码" class="header-anchor">#</a> 开始编码</h2> <p>图已经画的很充分了，对于无限滚动加载列表要做什么，我们也有了清晰的认知，那么我们开始编码吧。</p> <p>要计算出需要加载第几页，我们需要2个属性:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">private</span> itemHeight <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> numberOfItems <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// 页面中的项数</span>
</code></pre></div><h3 id="pagebyscroll"><a href="#pagebyscroll" class="header-anchor">#</a> pageByScroll$</h3> <p><code>pageByScroll$</code> 流如下所示:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">private</span> pageByScroll$ <span class="token operator">=</span> 
  <span class="token comment">// 首先，我们要创建一个流，它包含发生在 window 对象上的所有滚动事件</span>
	Observable<span class="token punctuation">.</span><span class="token function">fromEvent</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token string">&quot;scroll&quot;</span><span class="token punctuation">)</span> 
  <span class="token comment">// 我们只对这些事件的 scrollY 值感兴趣</span>
  <span class="token comment">// 所以创建一个只包含这些值的流</span>
	<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> window<span class="token punctuation">.</span>scrollY<span class="token punctuation">)</span>
  <span class="token comment">// 创建一个只包含过滤值的流</span>
  <span class="token comment">// 我们只需要当我们在视口外滚动时的值</span>
	<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>current <span class="token operator">=&gt;</span> current <span class="token operator">&gt;=</span>  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientHeight <span class="token operator">-</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span>
  <span class="token comment">// 只有当用户停止滚动200ms后，我们才继续执行</span>
  <span class="token comment">// 所以为这个流添加200ms的 debounce 时间</span>
	<span class="token punctuation">.</span><span class="token function">debounceTime</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> 
  <span class="token comment">// 过滤掉重复的值</span>
	<span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token comment">// 计算页码</span>
	<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>y <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfItems<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// --------1---2----3------2...</span>
</code></pre></div><p><strong>注意: 在真实应用中，你可能想要使用 window 和 document 的注入服务</strong></p> <h3 id="pagebyresize"><a href="#pagebyresize" class="header-anchor">#</a> pageByResize$</h3> <p><code>pageByResize$</code> 流如下所示:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>  <span class="token keyword">private</span> pageByResize$ <span class="token operator">=</span> 
  <span class="token comment">// 现在，我们要创建一个流，它包含发生在 window 对象上的所有 resize 事件</span>
	Observable<span class="token punctuation">.</span><span class="token function">fromEvent</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token string">&quot;resize&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// 当用户停止操作200ms后，我们才继续执行</span>
	<span class="token punctuation">.</span><span class="token function">debounceTime</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> 
  <span class="token comment">// 基于 window 计算页码</span>
   <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>
	   	<span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerHeight <span class="token operator">+</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop<span class="token punctuation">)</span> <span class="token operator">/</span> 
	   	<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfItems<span class="token punctuation">)</span>
   	<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
	<span class="token comment">// --------1---2----3------2...</span>
</code></pre></div><h3 id="pagebymanual"><a href="#pagebymanual" class="header-anchor">#</a> pageByManual$</h3> <p><code>pageByManual$</code> 流用来获取初始值(首屏数据)，但它同样需要我们手动控制。<code>BehaviorSubject</code> 非常适合，因为我们需要一个带有初始值的流，同时我们还可以手动添加值。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">private</span> pageByManual$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BehaviorSubject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1---2----3------...</span>
</code></pre></div><h3 id="pagetoload"><a href="#pagetoload" class="header-anchor">#</a> pageToLoad$</h3> <p>酷，已经有了3个页码的输入流，现在我们来创建 <code>pageToLoad$</code> 流。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">private</span> pageToLoad$ <span class="token operator">=</span> 
  <span class="token comment">// 将所有页码流合并成一个新的流</span>
	Observable<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pageByManual$<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageByScroll$<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageByResize$<span class="token punctuation">)</span>
  <span class="token comment">// 过滤掉重复的值</span>
	<span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token comment">// 检查当前页码是否存在于缓存(就是组件里的一个数组属性)之中</span>
	<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>page <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">[</span>page<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><h3 id="itemresults"><a href="#itemresults" class="header-anchor">#</a> itemResults$</h3> <p>最难的部分已经完成了。现在我们拥有一个带页码的流，这十分有用。我们不再需要关心个别场景或是其他复杂的逻辑。每次 <code>pageToLoad$</code> 流有新值时，我们就只加载数据即可。<strong>就这么简单！！</strong></p> <p>我们将使用 <a href="http://reactivex.io/documentation/operators/flatmap.html" target="_blank" rel="noopener noreferrer"><code>flatmap</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 操作符来完成，因为调用数据本身返回的也是流。FlatMap (或 MergeMap) 会将高阶 Observable 打平。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>itemResults$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageToLoad$ 
  <span class="token comment">// 基于页码流来异步加载数据</span>
  <span class="token comment">// flatMap 是 meregMap 的别名</span>
	<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 加载一些星球大战中的角色</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://swapi.co/api/people?page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token comment">// 创建包含这些数据的流</span>
			<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>resp <span class="token operator">=&gt;</span> resp<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>results<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span>resp <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将页码添加到缓存中</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">[</span>page <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> resp<span class="token punctuation">;</span>
        <span class="token comment">// 如果页面仍有足够的空白空间，那么继续加载数据 :)</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfItems <span class="token operator">*</span> page<span class="token punctuation">)</span> <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>pageByManual$<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>page <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 最终，只返回包含数据缓存的流</span>
	<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><h3 id="结果"><a href="#结果" class="header-anchor">#</a> 结果</h3> <p>完整的代码如下所示:</p> <p><strong>注意 <a href="https://angular.io/guide/pipes#the-impure-asyncpipe" target="_blank" rel="noopener noreferrer">async pipe<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 负责整个订阅流程</strong>。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'infinite-scroll-list'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;table&gt;
   &lt;tbody&gt;
    &lt;tr *ngFor=&quot;let item of itemResults$ | async&quot; [style.height]=&quot;itemHeight + 'px'&quot;&gt;
      &lt;td&gt;&lt;/td&gt;
    &lt;/tr&gt;
   &lt;/tbody&gt;
   &lt;/table&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">InfiniteScrollListComponent</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> cache <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
  <span class="token keyword">private</span> pageByManual$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BehaviorSubject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> itemHeight <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> numberOfItems <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> 

  <span class="token keyword">private</span> pageByScroll$ <span class="token operator">=</span> Observable<span class="token punctuation">.</span><span class="token function">fromEvent</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token string">&quot;scroll&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> window<span class="token punctuation">.</span>scrollY<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>current <span class="token operator">=&gt;</span> current <span class="token operator">&gt;=</span>  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientHeight <span class="token operator">-</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">debounceTime</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>y <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfItems<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
  <span class="token keyword">private</span> pageByResize$ <span class="token operator">=</span> Observable<span class="token punctuation">.</span><span class="token function">fromEvent</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token string">&quot;resize&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">debounceTime</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerHeight <span class="token operator">+</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop<span class="token punctuation">)</span> <span class="token operator">/</span> 
        <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfItems<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    
  <span class="token keyword">private</span> pageToLoad$ <span class="token operator">=</span> Observable
    <span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pageByManual$<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageByScroll$<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageByResize$<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>page <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">[</span>page<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    
  itemResults$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageToLoad$ 
    <span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://swapi.co/api/people?page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>resp <span class="token operator">=&gt;</span> resp<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>results<span class="token punctuation">)</span>
      		<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span>resp <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">[</span>page <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> resp<span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfItems <span class="token operator">*</span> page<span class="token punctuation">)</span> <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>pageByManual$<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>page <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> http<span class="token operator">:</span> Http<span class="token punctuation">)</span><span class="token punctuation">{</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>这是<a href="http://plnkr.co/edit/WewXnQRj9xBA7yPveWLQ?p=preview" target="_blank" rel="noopener noreferrer">在线示例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的地址。(译者注: 报错跑不起来。。。囧)</p> <p>再一次 (正如我之前文章中所证明的)，我们不需要使用第三方解决方案来解决所有问题。无限滚动加载列表的代码并不多，而且还非常灵活。假设说我们想减少 DOM 的压力，每次加载100条数据，那么我们可以新创建一个流来做这件事 😃</p> <p>感谢阅读本文，希望你能喜欢。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/articles/articles/How-To-Use-RefCount.html" class="prev">
        [译] RxJS: 如何使用 refCount
      </a></span> <span class="next"><a href="/articles/articles/Learn-To-Combine-RxJS-Sequences-With-Super-Intuitive-Interactive-Diagrams.html">
        [译] RxJS: 使用超直观的交互图来学习组合操作符
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.de24a261.js" defer></script><script src="/assets/js/2.f6e3d3ee.js" defer></script><script src="/assets/js/8.b99143ac.js" defer></script>
  </body>
</html>
